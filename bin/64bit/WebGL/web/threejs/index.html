<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-touch-fullscreen" content="yes">
    <title>RDF LTD</title>
    <style>

        body {
            color: #cccccc;
            font-family: Monospace;
            font-size: 13px;
            text-align: center;
            background-color: #050505;
            margin: 0px;
            overflow: hidden;
        }

        #info {
            position: absolute;
            top: 0px;
            width: 100%;
            padding: 5px;
        }

        a {
            color: #0080ff;
        }
    </style>
</head>
<body>
    <div id="container"></div>
    <script type="text/javascript" src="../js/threejs/three.js"></script>
    <script type="text/javascript" src="../js/threejs/Detector.js"></script>
    <script type="text/javascript" src="../js/threejs/libs/stats.min.js"></script>
    <script type="text/javascript" src="../js/threejs/libs/dat.gui.min.js"></script>
    <script type="text/javascript" src="../js/threejs/controls/TrackballControls.js"></script>
    <script type="text/javascript" src="../js/gunzip.min.js"></script>
    <script type="text/javascript" src="../js/js.cookie.js"></script>
    <script type='text/javascript' src='../js/utils.js'></script>
    <script type='text/javascript' src='../js/threejs/utils/SceneUtils.js'></script>
    <script type='text/javascript' src="../js/threejs/utils/ShadowMapViewer.js"></script>
    <script type='text/javascript' src="../js/threejs/shaders/UnpackDepthRGBAShader.js"></script>
    <script type='text/javascript' src='geom.js'></script>
    <script type="text/javascript" src="settings.js"></script>

    <script>
        // ----------------------------------------------------------------------------------------
        if (!Detector.webgl) Detector.addGetWebGLMessage();

        // ----------------------------------------------------------------------------------------
        // ThreeJS
        var g_camera, g_scene, g_renderer, g_stats, g_controls;

        // ----------------------------------------------------------------------------------------
        // ThreeJS - pick/select
        var g_raycaster, g_conceptualFaces = [], g_mouse = new THREE.Vector2(), g_pickedObject = null, g_selectedObjects = [];

        // ----------------------------------------------------------------------------------------
        // ThreeJS - lights
        var g_dirLight, g_spotLight;

        // ----------------------------------------------------------------------------------------
        // ThreeJS - shadows
        var g_dirLightShadowMapViewer, g_spotLightShadowMapViewer;

        // ----------------------------------------------------------------------------------------
        // Reuse the textures
        var g_dicTexture2Instance = {};

        // ----------------------------------------------------------------------------------------
        var g_worldBoundingBox = null;

        // ----------------------------------------------------------------------------------------
        init();
        animate();

        // ----------------------------------------------------------------------------------------
        function init() {
            /*
             * Camera
             */
            g_camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000000);
            g_camera.position.x = 0;
            g_camera.position.y = 0;
            g_camera.position.z = -10;

            /*
             * Scene
             */
            g_scene = new THREE.Scene();
            g_scene.background = new THREE.Color(0x000000);
            g_scene.receiveShadow = true;

            /*
             * Ambient light
             */
            var ambientLight = new THREE.AmbientLight(0x555555);
            g_scene.add(ambientLight);

            /*
             * Raycaster
             */
            g_raycaster = new THREE.Raycaster();

            /*
             * Renderer
             */
            g_renderer = new THREE.WebGLRenderer({ antialias: true });
            g_renderer.setPixelRatio(window.devicePixelRatio);
            g_renderer.setSize(window.innerWidth, window.innerHeight);
            g_renderer.shadowMap.enabled = true;
            g_renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            g_renderer.gammaInput = true;
            g_renderer.gammaOutput = true;

            /*
             * Load
             */
            loadInstances();

            /*
             * Center and zoom
             */
            console.log(g_worldBoundingBox);
            for (var i = 0; i < g_scene.children.length; i++) {
                if (g_scene.children[i].userData.instance === undefined) {
                    continue;
                }

                /*
                 * Default rotation
                 */
                g_scene.children[i].rotation.x = X_ROTATION * Math.PI / 180;
                g_scene.children[i].rotation.y = Y_ROTATION * Math.PI / 180;
                g_scene.children[i].rotation.z = Z_ROTATION * Math.PI / 180;

                g_scene.children[i].translateX(-g_worldBoundingBox.Xmin);
                g_scene.children[i].translateX(-(g_worldBoundingBox.Xmax - g_worldBoundingBox.Xmin) / 2);

                g_scene.children[i].translateY(-g_worldBoundingBox.Ymin);
                g_scene.children[i].translateY(-(g_worldBoundingBox.Ymax - g_worldBoundingBox.Ymin) / 2);

                g_scene.children[i].translateZ(-g_worldBoundingBox.Zmin);
                g_scene.children[i].translateZ(-(g_worldBoundingBox.Zmax - g_worldBoundingBox.Zmin) / 2);
            } // for (var i = ...

            var maxDimension = g_worldBoundingBox.Xmax - g_worldBoundingBox.Xmin;
            maxDimension = Math.max(maxDimension, g_worldBoundingBox.Ymax - g_worldBoundingBox.Ymin);
            maxDimension = Math.max(maxDimension, g_worldBoundingBox.Zmax - g_worldBoundingBox.Zmin);
            console.log(maxDimension);

            g_camera.position.z = -2 * maxDimension;

            /*
             * Spot light
             */
            g_spotLight = new THREE.SpotLight(0xffffff);
            g_spotLight.name = 'Spot Light';
            g_spotLight.angle = Math.PI / 5;
            g_spotLight.penumbra = 0.3;
            g_spotLight.position.set(0, 1.7 * maxDimension, 0);

            if (SPOT_LIGHT_SHADOW) {
                g_spotLight.castShadow = true;
                g_spotLight.shadow.camera.near = maxDimension;
                g_spotLight.shadow.camera.far = 2.5 * maxDimension;
                g_spotLight.shadow.mapSize.width = 1024;
                g_spotLight.shadow.mapSize.height = 1024;
            }

            g_scene.add(g_spotLight);

            if (SPOT_LIGHT_CAMERA_HELPER) {
                g_scene.add(new THREE.CameraHelper(g_spotLight.shadow.camera));
            }

            if (SPOT_LIGHT_SHADOW_MAP_VIEWER) {
                g_spotLightShadowMapViewer = new THREE.ShadowMapViewer(g_spotLight);
                g_spotLightShadowMapViewer.size.set(256, 256);
                g_spotLightShadowMapViewer.position.set(276, 10);
            }

            /*
             * Directional light
             */
            g_dirLight = new THREE.DirectionalLight(0xffffff, 1);
            g_dirLight.name = 'Dir. Light';
            g_dirLight.position.set(maxDimension / 2, 1.7 * maxDimension, 0);

            if (DIR_LIGHT_SHADOW) {
                g_dirLight.castShadow = true;
                g_dirLight.shadow.camera.near = maxDimension;
                g_dirLight.shadow.camera.far = 2.5 * maxDimension;
                g_dirLight.shadow.camera.right = maxDimension;
                g_dirLight.shadow.camera.left = -maxDimension;
                g_dirLight.shadow.camera.top = maxDimension;
                g_dirLight.shadow.camera.bottom = -maxDimension;
                g_dirLight.shadow.mapSize.width = 1024;
                g_dirLight.shadow.mapSize.height = 1024;
            }

            g_scene.add(g_dirLight);

            if (DIR_LIGHT_CAMERA_HELPER) {
                g_scene.add(new THREE.CameraHelper(g_dirLight.shadow.camera));
            }

            if (DIR_LIGHT_SHADOW_MAP_VIEWER) {
                g_dirLightShadowMapViewer = new THREE.ShadowMapViewer(g_dirLight);
                g_dirLightShadowMapViewer.position.x = 10;
                g_dirLightShadowMapViewer.position.y = 10;
                g_dirLightShadowMapViewer.size.width = 256;
                g_dirLightShadowMapViewer.size.height = 256;
                g_dirLightShadowMapViewer.update(); //Required when setting position or size directly
            }

            var groundMaterial = new THREE.MeshPhongMaterial({
                color: 0x404040,
                specular: 0x111111,
                //side: THREE.DoubleSide
            });

            if (SHADOW_PLANE) {
                var mesh = new THREE.Mesh(new THREE.PlaneBufferGeometry(2 * maxDimension, 2 * maxDimension), groundMaterial);
                mesh.rotation.x = - Math.PI / 2;
                mesh.position.y = -maxDimension / 2;
                mesh.receiveShadow = true;
                g_scene.add(mesh);
            }

            document.body.appendChild(g_renderer.domElement);

            /*
             * Axes
             */
            if (SHOW_AXES) {
                var axesHelper = new THREE.AxesHelper(2 * maxDimension);
                g_scene.add(axesHelper);
            }

            /*
             * Controls
             */
            g_controls = new THREE.TrackballControls(g_camera, g_renderer.domElement);
            g_controls.staticMoving = true;
            g_controls.rotateSpeed = 15;

            /*
             * FPS
             */
            g_stats = new Stats();
            document.body.appendChild(g_stats.dom);

            /*
             * GUI
             */
            var gui = new dat.GUI({ width: 300 });
            gui.open();

            /*
             * Directional Light
             */
            var dirLightParams = {
                Color: g_dirLight.color.getHex(),
                Intensity: g_dirLight.intensity,
                X: g_dirLight.position.x,
                Y: g_dirLight.position.y,
                Z: g_dirLight.position.z,
            };

            var dirLightFolder = gui.addFolder('Directional Light');

            dirLightFolder.addColor(dirLightParams, 'Color').onChange(function (val) {
                g_dirLight.color.setHex(val);
            });

            dirLightFolder.add(dirLightParams, 'Intensity', 0.0, 4.0).step(0.01).onChange(function (val) {
                g_dirLight.intensity = val;
            });

            dirLightFolder.open();

            dirLightFolder.add(dirLightParams, 'X').min(-200).max(200).step(0.0001).onChange(function (val) {
                g_dirLight.position.x = val;
            });

            dirLightFolder.add(dirLightParams, 'Y').min(-200).max(200).step(0.0001).onChange(function (val) {
                g_dirLight.position.y = val;
            });

            dirLightFolder.add(dirLightParams, 'Z').min(-200).max(200).step(0.0001).onChange(function (val) {
                g_dirLight.position.z = val;
            });

            /*
             * Spot Light
             */
            var spotLightParams = {
                Color: g_spotLight.color.getHex(),
                Intensity: g_spotLight.intensity,
                X: g_spotLight.position.x,
                Y: g_spotLight.position.y,
                Z: g_spotLight.position.z,
            };

            var spotLightFolder = gui.addFolder('Spot Light');

            spotLightFolder.addColor(spotLightParams, 'Color').onChange(function (val) {
                g_spotLight.color.setHex(val);
            });

            spotLightFolder.add(spotLightParams, 'Intensity', 0.0, 4.0).step(0.0001).onChange(function (val) {
                g_spotLight.intensity = val;
            });

            spotLightFolder.add(spotLightParams, 'X').min(-200).max(200).step(0.0001).onChange(function (val) {
                g_spotLight.position.x = val;
            });

            spotLightFolder.add(spotLightParams, 'Y').min(-200).max(200).step(0.0001).onChange(function (val) {
                g_spotLight.position.y = val;
            });

            spotLightFolder.add(spotLightParams, 'Z').min(-200).max(200).step(0.0001).onChange(function (val) {
                g_spotLight.position.z = val;
            });

            spotLightFolder.open();

            /*
             * Events
             */
            window.addEventListener('resize', onWindowResize, false);
            document.addEventListener('mousemove', onDocumentMouseMove, false);
            document.addEventListener('mouseup', onDocumentMouseUp, false);
        }

        // ----------------------------------------------------------------------------------------
        function loadInstances() {
            console.info("loadInstances - BEGIN");

            try {
                /*
                * Conceptual faces
                */
                for (var i = 0; i < g_instances.length; i++) {
                    var instance = g_instances[i];

                    if (instance.conceptualFaces === undefined) {
                        console.error("Unknown data model.");
                        continue;
                    }

                    if (instance.vertices !== undefined) {
                        /*
                        * Less than 64K vertices
                        */

                        const VERTEX_SIZE = instance.vertexSizeInBytes / 4/*bytes*/;
                        var hasUVs = VERTEX_SIZE == 8;

                        var vertices = [];
                        var normals = [];
                        var UVs = [];
                        for (var v = 0; v < instance.vertices.length / VERTEX_SIZE; v++) {
                            vertices.push(instance.vertices[(v * VERTEX_SIZE) + 0]);
                            vertices.push(instance.vertices[(v * VERTEX_SIZE) + 1]);
                            vertices.push(instance.vertices[(v * VERTEX_SIZE) + 2]);

                            normals.push(instance.vertices[(v * VERTEX_SIZE) + 3]);
                            normals.push(instance.vertices[(v * VERTEX_SIZE) + 4]);
                            normals.push(instance.vertices[(v * VERTEX_SIZE) + 5]);

                            if (hasUVs) {
                                UVs.push(instance.vertices[(v * VERTEX_SIZE) + 6]);
                                UVs.push(instance.vertices[(v * VERTEX_SIZE) + 7]);
                            }
                        } // for (var v = ...

                        for (var j = 0; j < instance.conceptualFaces.length; j++) {
                            var conceptualFace = instance.conceptualFaces[j];

                            if (conceptualFace.indices !== undefined) {
                                /*
                                * Less than 64 indices
                                */

                                var mesh = createConceptualFacesMesh(vertices, normals, UVs, conceptualFace.indices, conceptualFace.material);
                                mesh.userData.instance = instance;
                                g_conceptualFaces.push(mesh);
                                g_scene.add(mesh);
                            } // if (conceptualFace.indices !== undefined)
                            else {
                                /*
                                * More than 64 indices
                                */

                                if (conceptualFace.cohorts !== undefined) {
                                    for (var c = 0; c < conceptualFace.cohorts.length; c++) {
                                        var cohort = conceptualFace.cohorts[c];

                                        var mesh = createConceptualFacesMesh(vertices, normals, UVs, cohort.indices, conceptualFace.material);
                                        mesh.userData.instance = instance;
                                        g_conceptualFaces.push(mesh);
                                        g_scene.add(mesh);
                                    }
                                }
                                else {
                                    console.error("Unknown data model.");
                                }
                            } // else if (conceptualFace.indices !== undefined)
                        } // for (var j = ...
                    } // if (instance.vertices !== undefined)
                    else {
                        /*
                        * More than 64K vertices
                        */

                        for (var j = 0; j < instance.conceptualFaces.length; j++) {
                            var conceptualFace = instance.conceptualFaces[j];

                            if (conceptualFace.vertices === undefined) {
                                console.error("Unknown data model.");
                                continue;
                            }

                            const VERTEX_SIZE = conceptualFace.vertexSizeInBytes / 4/*bytes*/;
                            var hasUVs = VERTEX_SIZE == 8;

                            var vertices = [];
                            var normals = [];
                            var UVs = [];
                            for (var v = 0; v < conceptualFace.vertices.length / VERTEX_SIZE; v++) {
                                vertices.push(conceptualFace.vertices[(v * VERTEX_SIZE) + 0]);
                                vertices.push(conceptualFace.vertices[(v * VERTEX_SIZE) + 1]);
                                vertices.push(conceptualFace.vertices[(v * VERTEX_SIZE) + 2]);

                                normals.push(conceptualFace.vertices[(v * VERTEX_SIZE) + 3]);
                                normals.push(conceptualFace.vertices[(v * VERTEX_SIZE) + 4]);
                                normals.push(conceptualFace.vertices[(v * VERTEX_SIZE) + 5]);

                                if (hasUVs) {
                                    UVs.push(conceptualFace.vertices[(v * VERTEX_SIZE) + 6]);
                                    UVs.push(conceptualFace.vertices[(v * VERTEX_SIZE) + 7]);
                                }
                            } // for (var v = ...

                            if (conceptualFace.indices !== undefined) {
                                /*
                                * Less than 64 indices
                                */

                                var mesh = createConceptualFacesMesh(vertices, normals, UVs, conceptualFace.indices, conceptualFace.material);
                                mesh.userData.instance = instance;
                                g_conceptualFaces.push(mesh);
                                g_scene.add(mesh);
                            } // if (conceptualFace.indices !== undefined)
                            else {
                                /*
                                * More than 64 indices
                                */

                                if (conceptualFace.cohorts !== undefined) {
                                    for (var c = 0; c < conceptualFace.cohorts.length; c++) {
                                        var cohort = conceptualFace.cohorts[c];

                                        var mesh = createConceptualFacesMesh(vertices, normals, UVs, cohort.indices, conceptualFace.material);
                                        mesh.userData.instance = instance;
                                        g_conceptualFaces.push(mesh);
                                        g_scene.add(mesh);
                                    }
                                }
                                else {
                                    console.error("Unknown data model.");
                                }
                            } // else if (conceptualFace.indices !== undefined)
                        } // for (var j = ...
                    } // else if (instance.vertices != ...
                } // for (var i = ...

                /*
                * Conceptual faces polygons
                */
                for (var i = 0; i < g_instances.length; i++) {
                    var instance = g_instances[i];

                    if (instance.conceptualFacesPolygons === undefined) {
                        continue;
                    }

                    for (var j = 0; j < instance.conceptualFacesPolygons.length; j++) {
                        var conceptualFacesPolygon = instance.conceptualFacesPolygons[j];

                        /*
                        * VBO
                        */
                        var vertices = [];
                        if (conceptualFacesPolygon.vertices !== undefined) {
                            const VERTEX_SIZE = conceptualFacesPolygon.vertexSizeInBytes / 4/*bytes*/;

                            for (var v = 0; v < conceptualFacesPolygon.vertices.length / VERTEX_SIZE; v++) {
                                vertices.push(conceptualFacesPolygon.vertices[(v * VERTEX_SIZE) + 0]);
                                vertices.push(conceptualFacesPolygon.vertices[(v * VERTEX_SIZE) + 1]);
                                vertices.push(conceptualFacesPolygon.vertices[(v * VERTEX_SIZE) + 2]);
                            } // for (var v = ...
                        }
                        else {
                            if (instance.vertices !== undefined) {
                                const VERTEX_SIZE = instance.vertexSizeInBytes / 4/*bytes*/;

                                for (var v = 0; v < instance.vertices.length / VERTEX_SIZE; v++) {
                                    vertices.push(instance.vertices[(v * VERTEX_SIZE) + 0]);
                                    vertices.push(instance.vertices[(v * VERTEX_SIZE) + 1]);
                                    vertices.push(instance.vertices[(v * VERTEX_SIZE) + 2]);
                                } // for (var v = ...
                            }
                            else {
                                console.error("Unknown data model.");
                            }
                        }

                        /*
                        * IBO
                        */
                        if (conceptualFacesPolygon.indices !== undefined) {
                            var mesh = createConceptualFacesPolygonsMesh(vertices, conceptualFacesPolygon.indices);
                            mesh.userData.instance = instance;
                            g_scene.add(mesh);
                        }
                        else {
                            if (conceptualFacesPolygon.cohorts != undefined) {
                                for (var c = 0; c < conceptualFacesPolygon.cohorts.length; c++) {
                                    var cohort = conceptualFacesPolygon.cohorts[c];

                                    var mesh = createConceptualFacesPolygonsMesh(vertices, cohort.indices);
                                    mesh.userData.instance = instance;
                                    g_scene.add(mesh);
                                } // for (var c =
                            } // if (conceptualFacesPolygon.cohorts != ...
                            else {
                                console.error("Unknown data model.");
                            }
                        }
                    } // for (var j = ...
                } // for (var i = ...
            }
            catch (e) {
                console.error(e);
            }

            console.info("loadInstances - END");
        }

        // ----------------------------------------------------------------------------------------
        function createConceptualFacesPolygonsMesh(vertices, indices) {
            var geometry = new THREE.BufferGeometry();
            geometry.setIndex(new THREE.Uint16BufferAttribute(indices, 1));
            geometry.addAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));

            geometry.computeBoundingSphere();

            geometry.setDrawRange(0, 20);

            var material = new THREE.LineBasicMaterial({
                color: 0x000000,
                linewidth: 1, // in pixels
            });

            var mesh = new THREE.LineSegments(geometry, material);
            return mesh;
        }

        // ----------------------------------------------------------------------------------------
        function createConceptualFacesMesh(vertices, normals, UVs, indices, material) {
            var geometry = new THREE.BufferGeometry();
            geometry.setIndex(new THREE.Uint16BufferAttribute(indices, 1));

            geometry.addAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
            geometry.addAttribute('normal', new THREE.Float32BufferAttribute(normals, 3));

            var meshMaterial = null;
            if (material.texture === undefined) {
                meshMaterial = new THREE.MeshPhongMaterial({
                    color: new THREE.Color(material.ambient[0], material.ambient[1], material.ambient[2]),
                    emissive: new THREE.Color(material.emissive[0], material.emissive[1], material.emissive[2]),
                    specular: new THREE.Color(material.specular[0], material.specular[1], material.specular[2]),
                    transparent: material.transparency < 1.0,
                    opacity: material.transparency,
                    shininess: 50,
                    reflectivity: 0.5,
                    vertexColors: THREE.NoColors,
                    side: THREE.DoubleSide
                });
            } // if (material.texture === undefined)
            else {
                geometry.addAttribute('uv', new THREE.Float32BufferAttribute(UVs, 2));

                meshMaterial = new THREE.MeshLambertMaterial({
                    side: THREE.DoubleSide
                });

                var textureLoader = new THREE.TextureLoader();
                textureLoader.load(material.texture.base64Content,
                    // onLoad callback
                    function (texture) {
                        if (!g_dicTexture2Instance.hasOwnProperty(material.texture.name)) {
                            if (isPowerOfTwo(texture.image.naturalWidth) && isPowerOfTwo(texture.image.naturalHeight)) {
                                texture.wrapS = texture.wrapT = THREE.MirroredRepeatWrapping;
                                texture.minFilter = THREE.LinearMipMapLinearFilter;
                            }
                            else {
                                texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
                                texture.minFilter = THREE.LinearFilter;
                            }

                            texture.anisotropy = g_renderer.capabilities.getMaxAnisotropy();

                            meshMaterial.map = meshMaterial.bumpMap = texture;

                            g_dicTexture2Instance[material.texture.name] = texture;
                        }
                        else {
                            texture.dispose();

                            meshMaterial.map = meshMaterial.bumpMap = g_dicTexture2Instance[material.texture.name];
                        }

                        meshMaterial.needsUpdate = true;
                    },
                    // onProgress callback currently not supported
                    undefined,
                    // onError callback
                    function (err) {
                        console.error(err);
                    });
            } // else if (material.texture === undefined)

            /*
            * Calculate world's dimensions
            */
            geometry.computeBoundingBox();

            if (g_worldBoundingBox == null) {
                g_worldBoundingBox = {
                    Xmin: geometry.boundingBox.min.x,
                    Ymin: geometry.boundingBox.min.y,
                    Zmin: geometry.boundingBox.min.z,
                    Xmax: geometry.boundingBox.max.x,
                    Ymax: geometry.boundingBox.max.y,
                    Zmax: geometry.boundingBox.max.z
                };
            }
            else {
                g_worldBoundingBox.Xmin = Math.min(g_worldBoundingBox.Xmin, geometry.boundingBox.min.x);
                g_worldBoundingBox.Ymin = Math.min(g_worldBoundingBox.Ymin, geometry.boundingBox.min.y);
                g_worldBoundingBox.Zmin = Math.min(g_worldBoundingBox.Zmin, geometry.boundingBox.min.z);

                g_worldBoundingBox.Xmax = Math.max(g_worldBoundingBox.Xmax, geometry.boundingBox.max.x);
                g_worldBoundingBox.Ymax = Math.max(g_worldBoundingBox.Ymax, geometry.boundingBox.max.y);
                g_worldBoundingBox.Zmax = Math.max(g_worldBoundingBox.Zmax, geometry.boundingBox.max.z);
            }

            var mesh = new THREE.Mesh(geometry, meshMaterial);
            mesh.castShadow = true;
            mesh.receiveShadow = true;

            return mesh;
        }

        // ----------------------------------------------------------------------------------------
        function onDocumentMouseMove(event) {
            event.preventDefault();

            g_mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            g_mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
        }

        // ----------------------------------------------------------------------------------------
        function onDocumentMouseUp(event) {
            event.preventDefault();

            if (event.ctrlKey) {
                if (event.altKey) {
                    /*
                    * Reset
                    */
                    g_controls.reset();
                } // if (event.altKey)
                else {
                    /*
                    * Reset the controls - translate X/Y/Z
                    */
                    g_controls.target.set(0, 0, 0);

                    /*
                    * Zoom to
                    */
                    var pickedObject = getPickedObject();
                    if (pickedObject !== null) {
                        for (var i = 0; i < g_scene.children.length; i++) {
                            if (g_scene.children[i].userData.instance === undefined) {
                                continue;
                            }

                            g_scene.children[i].translateZ((g_worldBoundingBox.Zmax - g_worldBoundingBox.Zmin) / 2);
                            g_scene.children[i].translateZ(g_worldBoundingBox.Zmin);

                            g_scene.children[i].translateY((g_worldBoundingBox.Ymax - g_worldBoundingBox.Ymin) / 2);
                            g_scene.children[i].translateY(g_worldBoundingBox.Ymin);

                            g_scene.children[i].translateX((g_worldBoundingBox.Xmax - g_worldBoundingBox.Xmin) / 2);
                            g_scene.children[i].translateX(g_worldBoundingBox.Xmin);
                        } // for (var i = ...

                        g_worldBoundingBox = {
                            Xmin: pickedObject.userData.instance.Xmin,
                            Ymin: pickedObject.userData.instance.Ymin,
                            Zmin: pickedObject.userData.instance.Zmin,
                            Xmax: pickedObject.userData.instance.Xmax,
                            Ymax: pickedObject.userData.instance.Ymax,
                            Zmax: pickedObject.userData.instance.Zmax
                        };
                        console.log(g_worldBoundingBox);

                        for (var i = 0; i < g_scene.children.length; i++) {
                            if (g_scene.children[i].userData.instance === undefined) {
                                continue;
                            }

                            g_scene.children[i].translateX(-g_worldBoundingBox.Xmin);
                            g_scene.children[i].translateX(-(g_worldBoundingBox.Xmax - g_worldBoundingBox.Xmin) / 2);

                            g_scene.children[i].translateY(-g_worldBoundingBox.Ymin);
                            g_scene.children[i].translateY(-(g_worldBoundingBox.Ymax - g_worldBoundingBox.Ymin) / 2);

                            g_scene.children[i].translateZ(-g_worldBoundingBox.Zmin);
                            g_scene.children[i].translateZ(-(g_worldBoundingBox.Zmax - g_worldBoundingBox.Zmin) / 2);
                        } // for (var i = ...

                        var maxDimension = g_worldBoundingBox.Xmax - g_worldBoundingBox.Xmin;
                        maxDimension = Math.max(maxDimension, g_worldBoundingBox.Ymax - g_worldBoundingBox.Ymin);
                        maxDimension = Math.max(maxDimension, g_worldBoundingBox.Zmax - g_worldBoundingBox.Zmin);
                        console.log(maxDimension);

                        // |Camera position => (0, 0, 0)|
                        var cameraDistance = Math.sqrt(
                            Math.pow(g_camera.position.x, 2) +
                            Math.pow(g_camera.position.y, 2) +
                            Math.pow(g_camera.position.z, 2));

                        // |Target position => (0, 0, 0)|
                        var targetDistance = 2 * maxDimension;

                        var factor = targetDistance / cameraDistance;

                        g_camera.position.x *= factor;
                        g_camera.position.y *= factor;
                        g_camera.position.z *= factor;
                        g_camera.updateProjectionMatrix();
                    } // if (pickedObject !== null)
                } // else if (event.altKey)
            } // if (event.ctrlKey)
            else {
                var pickedObject = getPickedObject();
                if (pickedObject !== null) {
                    if (MULTI_SELECTION_MODE) {
                        var index = g_selectedObjects.indexOf(pickedObject);
                        if (index === -1) {
                            if ((pickedObject.colorHex === undefined) && (pickedObject.transparent === undefined)) {
                                g_pickedObject.colorHex = g_pickedObject.material.color.getHex();
                                g_pickedObject.transparent = g_pickedObject.material.transparent;
                            }

                            // Select
                            g_selectedObjects.push(pickedObject);
                        }
                        else {
                            // Unselect
                            if (g_selectedObjects[index] === g_pickedObject) {
                                g_pickedObject.material.color.setHex(PICKED_OBJECT_COLOR);
                                g_pickedObject.material.transparent = false;
                            }

                            g_selectedObjects[index].material.color.setHex(g_selectedObjects[index].colorHex);
                            g_selectedObjects[index].material.transparent = g_selectedObjects[index].transparent;

                            g_selectedObjects.splice(index, 1);
                        }
                    } // if (MULTI_SELECTION_MODE)
                    else {
                        for (var i = 0; i < g_selectedObjects.length; i++) {
                            if (g_selectedObjects[i] === g_pickedObject) {
                                g_pickedObject.material.color.setHex(PICKED_OBJECT_COLOR);
                                g_pickedObject.material.transparent = false;

                                continue;
                            }

                            g_selectedObjects[i].material.color.setHex(g_selectedObjects[i].colorHex);
                            g_selectedObjects[i].material.transparent = g_selectedObjects[i].transparent;
                        }

                        g_selectedObjects = [];

                        if ((pickedObject.colorHex === undefined) && (pickedObject.transparent === undefined)) {
                            pickedObject.colorHex = pickedObject.material.color.getHex();
                            pickedObject.transparent = pickedObject.material.transparent;
                        }                                              

                        g_selectedObjects.push(pickedObject);
                    } // if (pickedObject)                    
                } // if (pickedObject !== null)
                else {
                    for (var i = 0; i < g_selectedObjects.length; i++) {
                        if (g_selectedObjects[i] === g_pickedObject) {

                            g_pickedObject.material.color.setHex(PICKED_OBJECT_COLOR);
                            g_pickedObject.material.transparent = false;

                            continue;
                        }

                        g_selectedObjects[i].material.color.setHex(g_selectedObjects[i].colorHex);
                        g_selectedObjects[i].material.transparent = g_selectedObjects[i].transparent;
                    }                    

                    g_selectedObjects = [];
                }
            } // else if (event.ctrlKey)
        }

        // ----------------------------------------------------------------------------------------
        function onWindowResize() {
            g_camera.aspect = window.innerWidth / window.innerHeight;
            g_camera.updateProjectionMatrix();

            g_renderer.setSize(window.innerWidth, window.innerHeight);

            if (DIR_LIGHT_SHADOW_MAP_VIEWER) {
                g_dirLightShadowMapViewer.updateForWindowResize();
            }

            if (SPOT_LIGHT_SHADOW_MAP_VIEWER) {
                g_spotLightShadowMapViewer.updateForWindowResize();
            }
        }

        // ----------------------------------------------------------------------------------------
        function animate() {
            requestAnimationFrame(animate);

            render();

            g_controls.update();

            g_stats.update();
        }

        // ----------------------------------------------------------------------------------------
        function render() {
            /*
             * Pick an onject
             */
            var pickedObject = getPickedObject();
            if (pickedObject !== null) {
                if (g_pickedObject !== pickedObject) {
                    if (g_pickedObject !== null) {
                        var index = g_selectedObjects.indexOf(g_pickedObject);
                        if (index === -1) {
                            g_pickedObject.material.color.setHex(g_pickedObject.colorHex);
                            g_pickedObject.material.transparent = g_pickedObject.transparent;
                        }
                        else {
                            g_pickedObject.material.color.setHex(SELECTED_OBJECT_COLOR);
                            g_pickedObject.material.transparent = false;
                        }
                    } // if (g_pickedObject !== null)

                    g_pickedObject = pickedObject;

                    if ((pickedObject.colorHex === undefined) && (pickedObject.transparent === undefined)) {
                        g_pickedObject.colorHex = g_pickedObject.material.color.getHex();
                        g_pickedObject.transparent = g_pickedObject.material.transparent;
                    }

                    g_pickedObject.material.color.setHex(PICKED_OBJECT_COLOR);
                    g_pickedObject.material.transparent = false;
                } // if (g_pickedObject !== pickedObject)
            } else {
                if (g_pickedObject !== null) {
                    var index = g_selectedObjects.indexOf(g_pickedObject);
                    if (index === -1) {
                        g_pickedObject.material.color.setHex(g_pickedObject.colorHex);
                        g_pickedObject.material.transparent = g_pickedObject.transparent;
                    }
                    else {
                        g_pickedObject.material.color.setHex(SELECTED_OBJECT_COLOR);
                        g_pickedObject.material.transparent = false;
                    }
                }

                g_pickedObject = null;
            } // else if (g_pickedObject != pickedObject)

            /*
            * Render
            */
            g_renderer.render(g_scene, g_camera);

            renderShadowMapViewers();
        }

        // ----------------------------------------------------------------------------------------
        function getPickedObject() {
            g_raycaster.setFromCamera(g_mouse, g_camera);

            if (g_conceptualFaces.length > 0) {
                var intersects = g_raycaster.intersectObjects(g_conceptualFaces);

                if (intersects.length > 0) {
                    return intersects[0].object;
                }
            }

            return null;
        }

        // ----------------------------------------------------------------------------------------
        function renderShadowMapViewers() {
            if (DIR_LIGHT_SHADOW_MAP_VIEWER) {
                g_dirLightShadowMapViewer.render(g_renderer);
            }

            if (SPOT_LIGHT_SHADOW_MAP_VIEWER) {
                g_spotLightShadowMapViewer.render(g_renderer);
            }
        }

        // ----------------------------------------------------------------------------------------
        function isPowerOfTwo(value) {
            return (value & (value - 1)) === 0 && value !== 0;
        }

    </script>
</body>
</html>
